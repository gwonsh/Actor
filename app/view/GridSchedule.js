/*
 * File: app/view/GridSchedule.js
 *
 * This file was generated by Sencha Architect version 4.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Actor.view.GridSchedule', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.gridschedule',

    requires: [
        'Actor.view.GridGalleryViewModel2',
        'Ext.view.View',
        'Ext.XTemplate'
    ],

    config: {
        type: 'schedule'
    },

    viewModel: {
        type: 'gridschedule'
    },
    scrollable: true,
    bodyStyle: 'border-top:1px solid #cecece !important',
    closable: true,

    items: [
        {
            xtype: 'dataview',
            itemId: 'galleryView',
            tpl: Ext.create('Ext.XTemplate', 
                '<tpl if=\'values.length!=0\'>',
                '    <table width=\'100%\' height=\'30px\' cellspacing=\'0\' cellpadding=\'0\' border=\'0\' style=\'background-color:#ECF1F5;color:black\'>',
                '        <tr>',
                '            <td style=\'padding:10px 0 0 0;width:160px;\'>',
                '                <div style="text-align:right;font-size:11px;height:100%;border-right:1px solid #5e93bb;padding-right:3px">{[this.getFirstDay(values)]}</div>',
                '            </td>',
                '            <td style=\'height:100%;padding-top:10px\'>{[this.getTimeline(values)]}</td>',
                '        </tr>',
                '    </table>',
                '    <div style=\'position:relative;margin-left:160px;top:-30px;right:0;\'>{[this.getTodayPosition(values.length, 60)]}</div>',
                '</tpl>',
                '<div style=\'width:100%\'></div>',
                '<tpl for=".">',
                '    <div class="sunit" >',
                '        <table style="width:100%;height:60px;border-bottom:1px solid #cecece;background-color:white" cellspacing=\'0\' cellpadding=\'0\' border=\'0\'>',
                '            <tr>',
                '                <td style="width:160px;height:100%;border-right:1px solid #cecece;padding-left:10px;color:black">{bd_subject}</td>',
                '                {[this.getProgressBar(values)]}',
                '            </tr>',
                '        </table>',
                '    </div>',
                '</tpl>     ',
                {
                    getProgressBar: function(values) {
                        var configCtr = getController('Config');
                        var listTab = getController('Main').getListTab();
                        var period = new Date(listTab.maxTo) - new Date(listTab.minFrom);
                        var sDay = new Date(values.idfrom) - new Date(listTab.minFrom);
                        var toDay = new Date(listTab.maxTo) - new Date(new Date().toJSON().slice(0,10));
                        var eDay = new Date(listTab.maxTo) - new Date(values.idto);
                        var sPer = ((sDay/period)*100).toString() + '%';
                        var ePer = ((eDay/period)*100).toString() + '%';
                        var barBgcolor= '#0763ba';
                        // barBgcolor = '#d4e2ec';
                        var status = (values.idpercent === '' || values.idpercent === undefined || values.idpercent === null)? 0 : values.idpercent;
                        var html = '<td style="position:relative;right:0px;height:30px;">';
                        html +=	   '	<div style="position:absolute;left:'+sPer+';top:2px;font-size:10px;display:inline-block">'+values.idfrom+'</div>';
                        html +=	   '	<div style="background-color:'+barBgcolor+';position:absolute;left:'+sPer+';right:'+ePer+';top:16px;height:26px">';
                        html +=	   '		<div style="background-color:#0960ad;height:100%;width:'+status+'%"></div>';
                        html +=    '	</div>';
                        html +=	   '	<div style="position:absolute;right:'+ePer+';top:38px;font-size:10px;display:inline-block">'+values.idto+'</div>';
                        html +=	   '</td>';
                        return html;
                    },
                    getTimeline: function(values) {
                        var listTab = getController('Main').getListTab();
                        if(values.length === 0){
                            return;
                        }
                        var i;
                        var utilCtr = getController('Util');
                        var days = [];
                        var percents = [];
                        var ws = [];
                        var ft = [];
                        var period = new Date(listTab.maxTo) - new Date(listTab.minFrom);
                        var sepaDays = period/4;
                        var sDay = new Date(new Date(listTab.minFrom).setHours(0, 0, 0 , 0));//setHours to 0, because IE and Chrome defiault time set are different each aother
                        var len = 4;
                        var agg = 0;
                        for(i=0; i<len; i++){
                            var r = sDay.getDate() + sepaDays;
                            sDay.setMilliseconds(sDay.getMilliseconds() + sepaDays);
                            var pct = (sDay - new Date(listTab.minFrom)) / period * 100;
                            agg += pct;
                            var eachPeriod = sDay- new Date(listTab.minFrom);
                            var eachPct = (eachPeriod / period) * 100;
                            var preDate = (i == len - 1)? utilCtr.parseDate(sDay) :  Ext.Date.format(sDay, 'm-d');
                            days.push(preDate);
                            percents.push(pct);
                            var j = 0;
                            if(i > 0){
                                j = pct - percents[i-1];
                                ws.push(j);
                                ft.push('left');
                            }
                            if(i == len - 1){
                                ft.push('right');
                            }

                        }
                        var html = '';
                        for(i=0; i<days.length; i++){
                            html += '<div style="float:'+ft[i]+';width:'+ws[i]+'%;height:100%;font-size:11px;text-align:right;border-right:1px solid #5e93bb;padding-right:3px">'+days[i]+'</div>';
                        }
                        return html;
                    },
                    getFirstDay: function(values) {
                        if(values.length === 0){
                            return;
                        }
                        var val = getController('Util').parseDate(new Date(getController('Main').getListTab().minFrom));
                        return val;
                    },
                    getTodayPosition: function(valLen, unitHeight) {
                        var listTab = getController('Main').getListTab();
                        if(new Date() < new Date(listTab.minFrom) || new Date() > new Date(listTab.maxTo)) return;//pass if today is out of period
                        var period = new Date(listTab.maxTo) - new Date(listTab.minFrom);
                        var eDay;
                        if(!detectIE() || detectIE() > 12){
                            eDay = new Date(listTab.maxTo) - new Date(new Date().toJSON().slice(0,10));
                        }
                        else{
                            eDay = new Date(listTab.maxTo) - new Date(new Date().setHours(0, 0, 0 , 0));
                        }
                        var ePer = ((eDay/period)*100).toString() + '%';
                        var h = valLen * unitHeight + 15;
                        var html = '<i class="fa fa-thumb-tack" aria-hidden="true" style="margin-right:-3px;position:absolute;right:'+ePer+'" title="'+loc.menu.today+'"></i>';
                        html +=    '<div style="position:absolute;top:16px;width:1px;height:'+h+'px;right:'+ePer+';background-color:#f9873b;z-index:20;opacity:0.3"></div>';
                        return html;
                    }
                }
            ),
            itemSelector: 'div.sunit'
        }
    ]

});